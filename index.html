<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Profit Quest - AI Trading Log</title>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
        :root{--bg-color:#1a1a2e;--card-bg-color:#16213e;--primary-text-color:#e0e0e0;--secondary-text-color:#a0a0a0;--accent-color:#03dac6;--success-color:#4caf50;--danger-color:#f44336;--border-color:#0f3460;--font-family:'Poppins',sans-serif;--points-color:#ffc107;--streak-color:#ff5722}html{-webkit-tap-highlight-color:transparent}body{font-family:var(--font-family);background-color:var(--bg-color);color:var(--primary-text-color);margin:0;padding:1rem}.view{display:none}.view.active{display:block}.container{max-width:1200px;margin:0 auto;display:grid;gap:1rem;grid-template-columns:1fr}@media (min-width:1024px){.container{grid-template-columns:repeat(3,1fr)}}.card{background:var(--card-bg-color);border:1px solid var(--border-color);border-radius:1rem;padding:1.5rem}.card-header{margin-bottom:1rem;padding-bottom:.6rem;border-bottom:1px solid var(--border-color)}.card-title{font-weight:600;font-size:1.3rem;margin:0}.btn{display:inline-block;padding:.9rem 1.5rem;border:none;border-radius:.75rem;font-size:1.1rem;font-weight:600;cursor:pointer;transition:all .2s ease;text-align:center}.btn.full-width{display:block;width:100%}.btn:disabled{opacity:.5;cursor:not-allowed}.history-list{list-style:none;padding:0;margin:0;max-height:300px;overflow-y:auto}.history-item{display:flex;align-items:center;padding:.8rem 0;border-bottom:1px solid var(--border-color);gap:1rem}.history-details{flex-grow:1}.history-note{font-size:.8rem;color:var(--secondary-text-color);font-style:italic}.history-amount.profit{color:var(--success-color)}.history-amount.loss{color:var(--danger-color)}.delete-log{cursor:pointer;color:var(--secondary-text-color);transition:color .2s;padding:.5rem;font-size:1rem}@media (min-width:1024px){.two-thirds{grid-column:span 2}.one-third{grid-column:span 1}}#app-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}.chart-summary{display:flex;justify-content:space-around;text-align:center;margin-bottom:1.5rem}.summary-metric h4{color:var(--secondary-text-color);font-size:.9rem;font-weight:400;margin:0 0 .25rem 0}.summary-metric p{font-size:1.4rem;font-weight:600;margin:0}.thought-for-day{border-left:3px solid var(--points-color);padding-left:1rem;margin-top:1.5rem;font-style:italic;color:var(--secondary-text-color)}.ai-analysis-btn{background:none;border:1px solid var(--points-color);color:var(--points-color);font-size:.9rem;padding:.5rem 1rem}.modal-overlay{position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,.7);backdrop-filter:blur(5px);z-index:100;display:flex;align-items:center;justify-content:center;opacity:0;pointer-events:none;transition:opacity .3s ease}.modal-overlay.visible{opacity:1;pointer-events:auto}.modal-content{background:var(--card-bg-color);border:1px solid var(--border-color);padding:2rem;border-radius:1rem;max-width:600px;width:90%;text-align:left;transform:scale(.9);transition:transform .3s ease;line-height:1.8}.dashboard-metrics{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:1.5rem;text-align:center}.dashboard-metric h3{font-size:1rem;font-weight:400;color:var(--secondary-text-color);margin:0 0 .5rem 0}.dashboard-metric p{font-size:2.5rem;font-weight:700;margin:0;line-height:1.1}
        .log-form-container{display:grid;grid-template-columns:1fr;gap:1.5rem;margin-bottom:1.5rem}@media (min-width:600px){.log-form-container{grid-template-columns:1fr 1fr}}.input-group{display:flex;flex-direction:column}.input-group label{font-size:.9rem;color:var(--secondary-text-color);margin-bottom:.5rem}.input-field-wrapper{display:flex;align-items:center;background-color:rgba(0,0,0,.3);border:1px solid var(--border-color);border-radius:.75rem;transition:all .2s ease-in-out}.input-field-wrapper:focus-within{border-color:var(--accent-color);box-shadow:0 0 0 3px rgba(3,218,198,.3)}.input-symbol{padding:0 1rem;font-size:1.2rem;font-weight:600;color:var(--secondary-text-color);border-right:1px solid var(--border-color)}.input-field-wrapper input{width:100%;padding:.9rem 1rem;border:none;background:transparent;outline:none;color:var(--primary-text-color);font-size:1.2rem;font-family:var(--font-family)}input.main-input{font-weight:700;font-size:1.5rem}input[type=number]::-webkit-inner-spin-button,input[type=number]::-webkit-outer-spin-button{-webkit-appearance:none;margin:0}input[type=number]{-moz-appearance:textfield}.cta-button{display:flex;align-items:center;justify-content:center;gap:.75rem}.ai-buttons-group{display:flex;flex-direction:column;gap:1rem;margin-top:1rem;}
    </style>
</head>
<body>
    <div id="loading-view" class="view active" style="text-align: center; padding-top: 5rem;"><p>Loading Profit Quest...</p></div>
    <div id="auth-view" class="view"> <!-- Auth HTML injected by JS --> </div>
    <div id="app-view" class="view">
        <header id="app-header"><div id="user-info"></div><button id="btn-sign-out" class="btn btn-danger" style="padding: 0.5rem 1rem;">Sign Out</button></header>
        <div class="container">
            <div class="card full-width"> <div class="dashboard-metrics"><div class="dashboard-metric"><h3>Current Balance</h3><p id="dashboard-current-balance"></p></div><div class="dashboard-metric"><h3>Total Profit</h3><p id="dashboard-total-profit"></p></div><div class="dashboard-metric"><h3>Expected in 30 Days (30% Rule)</h3><p id="dashboard-projection" style="color: var(--accent-color)"></p></div></div> </div>
            <div class="card two-thirds">
                <div class="card-header"><h2 class="card-title">Log Today's Trade</h2></div>
                <form id="update-form">
                    <div class="log-form-container">
                        <div class="input-group">
                            <label for="profit-input">Profit/Loss</label>
                            <div class="input-field-wrapper">
                                <span class="input-symbol">‚Çπ</span>
                                <input name="profit" id="profit-input" type="number" class="main-input" placeholder="0.00" required step="any">
                            </div>
                        </div>
                        <div class="input-group">
                            <label for="note-input">Note (optional)</label>
                            <div class="input-field-wrapper">
                                <span class="input-symbol">üìù</span>
                                <input name="note" id="note-input" type="text" placeholder="e.g. Nifty breakout">
                            </div>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-primary full-width cta-button">Log Progress</button>
                </form>
            </div>
            <div class="card one-third"><div class="card-header"><h2 class="card-title">AI Assistant</h2></div><div class="ai-buttons-group"><button id="ai-quick-insight-btn" class="btn ai-analysis-btn">Get Quick Insight</button><button id="ai-deep-dive-btn" class="btn ai-analysis-btn">Request Deep Dive</button></div><div class="thought-for-day"><h4>Thought for the Day:</h4><p id="ai-thought">Loading...</p></div></div>
            <div class="card full-width"><div class="card-header"><h2 class="card-title">Account Growth Analysis</h2></div><div class="chart-summary"><div class="summary-metric"><h4>All-Time High</h4><p id="ath-balance"></p></div><div class="summary-metric"><h4>Growth %</h4><p id="growth-percentage"></p></div></div><div style="height:300px;"><canvas id="growth-chart"></canvas></div></div>
            <div class="card full-width"><div class="card-header"><h2 class="card-title">Transaction History</h2></div><ul id="history-list"></ul></div>
        </div>
    </div>
    <div id="ai-modal" class="modal-overlay"> <div class="modal-content"><h2 id="ai-modal-title" class="card-title" style="margin-bottom: 1rem;"></h2><div id="ai-analysis-result"></div><button id="ai-modal-close" class="btn btn-primary" style="margin-top: 1.5rem;">Close</button></div></div>
<script>
document.addEventListener('DOMContentLoaded', () => {
    // ---- 1. INJECT AUTH HTML & CONFIGURATION ---
    document.getElementById('auth-view').innerHTML = `<div class="card" style="max-width: 450px; margin: 3rem auto;"><div id="login-form-container"><h1 class="card-title">Welcome Back</h1><div class="error-message" id="login-error"></div><form id="login-form"><div class="form-group"><input name="email" type="email" class="form-input" placeholder="Email" required></div><div class="form-group"><input name="password" type="password" class="form-input" placeholder="Password" required></div><button type="submit" class="btn btn-primary full-width">Sign In</button></form><div style="text-align:center;margin:1rem 0;">or</div><button id="btn-google-signin" class="btn full-width" style="background-color:#fff; color:#333;">Continue with Google</button><p><a id="show-register-link" style="color:var(--accent-color); cursor:pointer; text-decoration:none; display:block; margin-top:1rem;text-align:center;">Don't have an account? Sign Up</a></p></div><div id="register-form-container" style="display:none;"><h1 class="card-title">Create Account</h1><div class="error-message" id="register-error"></div><form id="register-form"><div class="form-group"><input name="name" type="text" class="form-input" placeholder="Your Name" required></div><div class="form-group"><input name="email" type="email" class="form-input" placeholder="Email" required></div><div class="form-group"><input name="password" type="password" class="form-input" placeholder="Password" required></div><button type="submit" class="btn btn-primary full-width">Sign Up</button></form><p><a id="show-login-link" style="color:var(--accent-color); cursor:pointer; text-decoration:none; display:block; margin-top:1rem;text-align:center;">Already have an account? Sign In</a></p></div></div>`;
    const firebaseConfig = {
  apiKey: "AIzaSyBLjuZ6sIHSLTUG6O5_UIzOs7jBQiSuaQs",
  authDomain: "dailyprofit-6b2e9.firebaseapp.com",
  projectId: "dailyprofit-6b2e9",
  storageBucket: "dailyprofit-6b2e9.firebasestorage.app",
  messagingSenderId: "259444914899",
  appId: "1:259444914899:web:5af9b73b7397f21b223226",
  measurementId: "G-7PPM2BE5BY"
};
    const GEMINI_API_KEY = "AIzaSyDdp0THfzp04ORFoxLe6rkejyJGDRHf3N4";

    // --- 2. APP INITIALIZATION & STATE ---
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth(); const db = firebase.firestore();
    const STARTING_BALANCE = 1000;
    let state = {}, growthChart = null;

    // --- 3. HELPER & UTILITY FUNCTIONS ---
    const showView = (id) => { document.querySelectorAll('.view').forEach(v => v.classList.remove('active')); document.getElementById(id).classList.add('active'); };
    const formatCurrency = (amount) => new Intl.NumberFormat("en-IN", { style: "currency", currency: "INR" }).format(amount || 0);
    const callGemini = async (prompt) => { if (!GEMINI_API_KEY || GEMINI_API_KEY === "AIzaSyDdp0THfzp04ORFoxLe6rkejyJGDRHf3N4") { throw new Error("API Key not set."); } const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-pro:generateContent?key=${GEMINI_API_KEY}`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] }) }); if (!response.ok) throw new Error(`API Error: ${response.statusText}`); return (await response.json()).candidates[0].content.parts[0].text; };
    
    // --- 4. DATA HANDLING & RENDERING ---
    const loadAndRenderApp=async user=>{try{const userRef=db.collection("users").doc(user.uid);let userDoc=await userRef.get();if(!userDoc.exists){const newUserData={displayName:user.displayName,email:user.email,balance:STARTING_BALANCE,points:0,streak:0,lastUpdate:null};await userRef.set(newUserData);state={...newUserData,history:[]}}else{const userData=userDoc.data(),transactionsSnap=await userRef.collection("transactions").orderBy("date","desc").get();state={...userData,history:transactionsSnap.docs.map(doc=>({id:doc.id,...doc.data()}))}}renderUI();showView("app-view");fetchThoughtForTheDay()}catch(error){console.error("Critical Error:",error),document.getElementById("loading-view").innerHTML='<p style="color:red">Error: Could not load data.</p>'}};
    const renderUI=()=>{document.getElementById("user-info").textContent=`Welcome, ${state.displayName||"Trader"}`;document.getElementById("dashboard-current-balance").textContent=formatCurrency(state.balance);const totalProfit=state.balance-STARTING_BALANCE,totalProfitEl=document.getElementById("dashboard-total-profit");totalProfitEl.textContent=formatCurrency(totalProfit),totalProfitEl.style.color=totalProfit>=0?"var(--success-color)":"var(--danger-color)",document.getElementById("dashboard-projection").textContent=formatCurrency(state.balance*1.3**30),document.getElementById("history-list").innerHTML=state.history.length===0?"<li>No trades logged.</li>":state.history.map(item=>`<li class="history-item"><div class="history-details"><span class="history-amount ${item.amount>=0?"profit":"loss"}">${item.amount>=0?"+":""}${formatCurrency(item.amount)}</span> on ${item.date?item.date.toDate().toLocaleDateString("en-IN",{day:"numeric",month:"short"}):""}${item.note?`<div class="history-note">"${item.note}"</div>`:""}</div><span class="delete-log" data-id="${item.id}">üóëÔ∏è</span></li>`).join(""),renderAccountGrowth()};
    const renderAccountGrowth=()=>{const e=document.getElementById("growth-chart");let t=STARTING_BALANCE;const r=[...state.history].reverse().map(e=>(t+=e.amount,{balance:t,pnl:e.amount}));const o=state.balance-STARTING_BALANCE;document.getElementById("ath-balance").textContent=formatCurrency(Math.max(STARTING_BALANCE,...r.map(e=>e.balance)));const n=(o/STARTING_BALANCE*100),a=document.getElementById("growth-percentage");a.textContent=`${n.toFixed(1)}%`,a.style.color=n>=0?"var(--success-color)":"var(--danger-color)";growthChart&&growthChart.destroy(),growthChart=new Chart(e,{type:"line",data:{labels:["Start",...[...state.history].reverse().map(e=>e.date.toDate().toLocaleDateString("en-IN",{day:"numeric",month:"short"}))],datasets:[{label:"Balance",data:[STARTING_BALANCE,...r.map(e=>e.balance)],borderColor:"var(--accent-color)",fill:!1,tension:.1,pointBackgroundColor:["var(--secondary-text-color)",...r.map(e=>e.pnl>=0?"var(--success-color)":"var(--danger-color)")]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{ticks:{color:"var(--secondary-text-color)",callback:e=>"‚Çπ"+e/1e3+"k"}},x:{ticks:{color:"var(--secondary-text-color)"}}}}})};

    // --- 5. EVENT HANDLERS & INITIALIZATION ---
    const initEventListeners = () => {
        // --- Authentication Listeners ---
        document.getElementById('show-register-link').addEventListener('click',()=> { document.getElementById('login-form-container').style.display = 'none'; document.getElementById('register-form-container').style.display = 'block'; });
        document.getElementById('show-login-link').addEventListener('click',()=> { document.getElementById('register-form-container').style.display = 'none'; document.getElementById('login-form-container').style.display = 'block'; });
        document.getElementById('btn-google-signin').addEventListener('click', () => auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => document.getElementById('login-error').textContent = err.message));
        document.getElementById('btn-sign-out').addEventListener('click', () => auth.signOut());
        document.getElementById('login-form').addEventListener('submit', (e) => { e.preventDefault(); auth.signInWithEmailAndPassword(e.target.email.value, e.target.password.value).catch(err => document.getElementById('login-error').textContent = err.message); });
        document.getElementById('register-form').addEventListener('submit', async (e) => { e.preventDefault(); const name = e.target.name.value, email = e.target.email.value, password = e.target.password.value; try { const cred = await auth.createUserWithEmailAndPassword(email, password); await cred.user.updateProfile({ displayName: name }); await db.collection('users').doc(cred.user.uid).set({ displayName: name, email: email, balance: STARTING_BALANCE, points: 0, streak: 0, createdAt: firebase.firestore.FieldValue.serverTimestamp(), lastUpdate: null }); } catch (err) { document.getElementById('register-error').textContent = err.message; }});

        // --- Core App Listeners ---
        document.getElementById('update-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const amount = parseFloat(e.target.profit.value);
            const note = e.target.note.value;
            if (isNaN(amount)) return;
            try {
                const userRef = db.collection('users').doc(auth.currentUser.uid);
                await userRef.update({
                    balance: firebase.firestore.FieldValue.increment(amount),
                    points: firebase.firestore.FieldValue.increment(amount > 0 ? 25 : -50)
                });
                await userRef.collection('transactions').add({ amount, note, date: firebase.firestore.FieldValue.serverTimestamp() });
                e.target.reset();
                await loadAndRenderApp(auth.currentUser);
            } catch(error) { alert("Could not save trade."); }
        });
        
        document.getElementById('history-list').addEventListener('click', async (e) => {
            if (!e.target.matches('.delete-log')) return;
            const id = e.target.dataset.id;
            const transaction = state.history.find(t => t.id === id);
            if(transaction && confirm(`Delete transaction of ${formatCurrency(transaction.amount)}?`)){
                const userRef = db.collection('users').doc(auth.currentUser.uid);
                await userRef.update({ balance: firebase.firestore.FieldValue.increment(-transaction.amount), points: firebase.firestore.FieldValue.increment(-(transaction.amount > 0 ? 25 : -50)) });
                await userRef.collection('transactions').doc(id).delete();
                await loadAndRenderApp(auth.currentUser);
            }
        });

        // --- AI Listeners ---
        const handleAIRequest = async (button, prompt, title) => {
            button.textContent = 'AI is thinking...'; button.disabled = true;
            try {
                const analysisText = await callGemini(prompt);
                document.getElementById('ai-modal-title').textContent = title;
                document.getElementById('ai-analysis-result').innerHTML = analysisText.replace(/\n/g, '<br>').replace(/### (.*?)/g, '<h3>$1</h3>');
                document.getElementById('ai-modal').classList.add('visible');
            } catch (error) { alert(`Could not get AI analysis: ${error.message}`);
            } finally { button.textContent = title; button.disabled = false; }
        };

        document.getElementById('ai-quick-insight-btn').addEventListener('click', (e) => {
            if(state.history.length < 2) return alert("Log at least two trades for an insight.");
            const prompt = `Based on this trade history, provide a one-sentence "quick insight" about my performance. History: ${JSON.stringify(state.history.slice(0, 10).map(t => t.amount))}`;
            handleAIRequest(e.target, prompt, "Quick Insight");
        });
        document.getElementById('ai-deep-dive-btn').addEventListener('click', (e) => {
             if(state.history.length < 5) return alert("Log at least five trades for a deep dive.");
            const prompt = `As a trading coach, analyze this history (oldest to newest): ${[...state.history].reverse().map(e=>`- P/L: ${formatCurrency(e.amount)}, Note: "${e.note}"`).join("\n")}. Give a deep analysis in markdown: Winning Patterns, Losing Patterns, and an Actionable Tip.`;
            handleAIRequest(e.target, prompt, "Deep Dive Analysis");
        });

        document.getElementById('ai-modal-close').addEventListener('click', ()=>document.getElementById('ai-modal').classList.remove('visible'));
    };

    const fetchThoughtForTheDay = async () => {
        try {
            const thought = await callGemini("Give a unique, concise thought about trading psychology.");
            document.getElementById('ai-thought').textContent = `"${thought}"`;
        } catch(e) { document.getElementById('ai-thought').textContent = '"Discipline over conviction."'; }
    }
    
    // Auth state listener to kick everything off
    auth.onAuthStateChanged(user => {
        if (user) {
            loadAndRenderApp(user);
        } else {
            if(growthChart) growthChart.destroy();
            state = {};
            showView('auth-view');
        }
    });

    initEventListeners();
});
</script>
</body>
</html>
